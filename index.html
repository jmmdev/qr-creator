<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <meta http-equiv="Content-Security-Policy" content="img-src 'self' blob: data:">

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
        <link rel="stylesheet" href="styles.css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reinvented-color-wheel@0.4.0/css/reinvented-color-wheel.min.css">
              
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/reinvented-color-wheel@0.4.0"></script>  
        <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
        <script src="./ext/html2canvas.js"></script>

        <title>QR Creator</title>
    </head>
    <body>
        <header></header>
        <div class="main-container">
            <div class="header-container">
                <i class="bi-qr-code header-icon"></i>
                QR Creator
            </div>
            <div class="row">
                <div id="settings-container" class="settings-container col-md-7 col-lg-8">
                    <div class="settings-field enabled-field" onclick="showSettings(event)">
                        <i class="bi bi-link-45deg settings-field-icon"></i>
                        URL
                        <i class="bi bi-dash show-icon"></i>
                    </div>
                    <div id="url-settings" class="settings-content enabled-settings">
                        <div class="url-input">
                            <input id="url" type="text" placeholder="https://example.com" value="https://jmmdev.github.io/qr-creator" onkeyup="checkInputValue()" onkeydown="checkInputValue()" onkeypress="checkInputValue()"/>
                        </div>
                    </div>
                    <div class="settings-field disabled-field" onclick="showSettings(event)">
                        <i class="bi bi-square settings-field-icon"></i>
                        Marco
                        <i class="bi bi-plus show-icon"></i>
                    </div>
                    <div id="frame-settings" class="settings-content disabled-settings"></div>
                    <div class="settings-field disabled-field" onclick="showSettings(event)">
                        <i class="bi bi-image settings-field-icon"></i>
                        Logo
                        <i class="bi bi-plus show-icon"></i>
                    </div>
                    <div id="logo-settings" class="settings-content disabled-settings">
                        <input type="file" id="my-file" name="my-file" style="display: none" accept="image/png, image/jpeg, image/jpg" onchange="fileUpload()">
                        <div class="logo-button">
                            <button id="logo-button" type="button" class="btn btn-primary" onclick="clickFileUpload()"><i class="bi bi-upload"></i> Elegir archivo</button>
                        </div>
                        <div id="logo-info" class="logo-info">
                            Ningún archivo seleccionado
                        </div>
                        <div id="show-logo-container" class="show-logo-container">
                            <button id="show-logo" class="show-logo" type="button" onclick="doShowLogo()"><i class="bi bi-eye-slash-fill"></i></button>
                        </div>
                    </div>
                    <div class="settings-field disabled-field" onclick="showSettings(event)">
                        <i class="bi bi-palette settings-field-icon"></i>
                        Colores
                        <i class="bi bi-plus show-icon"></i>
                    </div>
                    <div id="color-settings" class="settings-content disabled-settings">
                        <div class="color-pickers">
                            <div id="front-color-div" class="color-container">
                                <div class="color-info">Color frontal</div>
                                <input type="text" readonly id="front-color-sample" class="color-sample" value="#" />
                                <div id="front-colorpicker" class="colorpicker hide-picker"></div>
                            </div>
                            <div id="back-color-div" class="color-container">
                                <div class="color-info">Color del fondo</div>
                                <input type="text" readonly id="back-color-sample" class="color-sample" value="#" />
                                <div id="back-colorpicker" class="colorpicker hide-picker"></div>
                            </div>
                        </div>
                        <div class="warning-text">
                            * Aviso: para que un código QR sea legible por la mayoría de aplicaciones de escaneo, 
                            el color frontal debe ser más oscuro que el color del fondo. Además debe haber una diferencia 
                            de contraste suficiente entre ambos colores para su correcto funcionamiento.
                        </div>
                    </div>
                </div>
                <div class="qr-container col-md-5 col-lg-4">
                    <div id="qr-preview" class="qr-preview">
                        <div id="qr-frame" class="qr-preview__frame">
                            <div id="loader" class="loader-container">
                                <div class="loader-background">
                                    <div class="loader-content">
                                        <div class="loader"></div>
                                        <div class="loader-message">Un momento...</div>
                                    </div>
                                </div>
                            </div>
                            <div id="qr-logo" class="qr-logo"></div>
                            <div id="qr-placeholder" class="qr-placeholder">
                                <div class="placeholder-text">PLACEHOLDER</div>
                                <div style="width: 100%; text-align: center; color: #999999; opacity: 60%; font-size: 2px; font-weight: 600; position: absolute; top: 50%; transform: translateY(-50%);">PLACEHOLDER</div>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" fill="black" class="bi bi-qr-code" viewBox="0 0 16 16">
                                        <path d="M2 2h2v2H2V2Z"/>
                                        <path d="M6 0v6H0V0h6ZM5 1H1v4h4V1ZM4 12H2v2h2v-2Z"/>
                                        <path d="M6 10v6H0v-6h6Zm-5 1v4h4v-4H1Zm11-9h2v2h-2V2Z"/>
                                        <path d="M10 0v6h6V0h-6Zm5 1v4h-4V1h4ZM8 1V0h1v2H8v2H7V1h1Zm0 5V4h1v2H8ZM6 8V7h1V6h1v2h1V7h5v1h-4v1H7V8H6Zm0 0v1H2V8H1v1H0V7h3v1h3Zm10 1h-1V7h1v2Zm-1 0h-1v2h2v-1h-1V9Zm-4 0h2v1h-1v1h-1V9Zm2 3v-1h-1v1h-1v1H9v1h3v-2h1Zm0 0h3v1h-2v1h-1v-2Zm-4-1v1h1v-2H7v1h2Z"/>
                                        <path d="M7 12h1v3h4v1H7v-4Zm9 2v2h-3v-1h2v-1h1Z"/>
                                    </svg>
                                </div>
                            <div id="qr-code" class="qr-code"></div>
                        </div>
                    </div>
                    <div class="save-buttons">
                        <button id="generate-button" type="button" class="btn btn-success" onclick="generateQR()">Generar QR</button>
                        <button id="download-button" type="button" class="btn btn-primary" style="display: none;" onclick="downloadQR()"><i class="bi bi-download"></i> Descargar</button>
                    </div>
                </div>
            </div>
            <div class="footer-container">
                <a href="mailto: josemaria.martin169@gmail.com" id="mail-button"><i class="bi bi-envelope"></i></a>
                <a href="https://www.linkedin.com/in/jos%C3%A9-mar%C3%ADa-mart%C3%ADn-mu%C3%B1oz-95a464195" target="_blank" id="linkedin-button"><i class="bi bi-linkedin"></i></a>
                <a href="https://github.com/jmmdev/qr-creator" target="_blank" id="github-button"><i class="bi bi-github"></i></a>
            </div>
        </div>

        <script type="text/javascript">
            $(document).ready(function() {
                var threshold = 180;

                var diameter;
                var thickness;

                if(window.innerWidth <= 425){
                    diameter = 120;
                    thickness = 10;
                }else{
                    diameter = 150;
                    thickness = 20;
                }


                var frontColorWheel = new ReinventedColorWheel({
                    appendTo: document.getElementById("front-colorpicker"),

                    wheelDiameter: diameter,
                    wheelThickness: thickness,
                    handleDiameter: 12,
                    wheelReflectsSaturation: false,

                    onChange: function (color) {
                        document.getElementById("front-color-sample").value = color.hex;
                        document.getElementById("front-color-sample").style.backgroundColor = color.hex;

                        var rgb = color.rgb;

                        if(rgb[0] >= threshold || rgb[1] >= threshold || rgb[2] >= threshold){
                            document.getElementById("front-color-sample").style.color = "#000000";
                        }else{
                            document.getElementById("front-color-sample").style.color = "#ffffff";    
                        }
                    },
                });

                var backColorWheel = new ReinventedColorWheel({
                    appendTo: document.getElementById("back-colorpicker"),

                    wheelDiameter: diameter,
                    wheelThickness: thickness,
                    handleDiameter: 12,
                    wheelReflectsSaturation: false,

                    onChange: function (color) {
                        document.getElementById("back-color-sample").value = color.hex;
                        document.getElementById("back-color-sample").style.backgroundColor = color.hex;

                        var rgb = color.rgb;

                        if(rgb[0] >= threshold || rgb[1] >= threshold || rgb[2] >= threshold){
                            document.getElementById("back-color-sample").style.color = "#000000";
                        }else{
                            document.getElementById("back-color-sample").style.color = "#ffffff";    
                        }
                    },
                });

                frontColorWheel.hex = '#000000';
                backColorWheel.hex = '#ffffff';

                window.addEventListener('resize', function(){
                    resizePickers(frontColorWheel, backColorWheel);
                });

                function resizePickers(frontColorWheel, backColorWheel) {
                    if(window.innerWidth <= 425){
                        frontColorWheel.wheelDiameter = 120;
                        frontColorWheel.wheelThickness = 10;

                        backColorWheel.wheelDiameter = 120;
                        backColorWheel.wheelThickness = 10;
                    }else{
                        frontColorWheel.wheelDiameter = 150;
                        frontColorWheel.wheelThickness = 20;

                        backColorWheel.wheelDiameter = 150;
                        backColorWheel.wheelThickness = 20;
                    }

                    frontColorWheel.redraw();
                    backColorWheel.redraw();
                }
            });
                
                
        </script>

        <script>
            function clickFileUpload(){
                document.getElementById("my-file").click();
            }
            
            function fileUpload(){
                var previewBorder = document.getElementById("qr-frame");
                var qrLogo = document.getElementById("qr-logo");
                var myFile = document.getElementById("my-file");
                var logoInfo = document.getElementById("logo-info");
                var showLogo = document.getElementById("show-logo-container");
                var lastPhoto = "";
                var photo = myFile.files[0];

                if(photo){
                    qrLogo.innerHTML = '<img src="' + URL.createObjectURL(photo) + '"/>';
                    qrLogo.style.display = "flex";
                    logoInfo.style.maxWidth = "40%";
                    logoInfo.innerHTML = photo.name;

                    lastPhoto = photo;

                    showLogo.style.display = "block";
                }
            }
            </script>

            <script>
                var lastColor = "#000000";
                var placeholder = document.getElementById("qr-placeholder");
                    var code = document.getElementById("qr-code");
                    var loader = document.getElementById("loader");
                    var logoButton = document.getElementById("logo-button");
                    var downloadButton = document.getElementById("download-button");
                    var frontColor = document.getElementById("front-color-sample");
                    var backColor = document.getElementById("back-color-sample");
                    var input = document.getElementById("url");
                    var frame = document.getElementById("qr-frame");

                function generateQR(){
                    var text = "";
                    var aux = document.createElement("div");
                    
                    if(input.value !== ""){
                        loader.style.display = "block";
                        downloadButton.disabled = true;
                        logoButton.disabled = true;

                        text = input.value;

                        var qr = new QRCode(aux, {
                            text: input.value,
                            width: 2000,
                            height: 2000,
                            colorDark: frontColor.value,
                            colorLight: backColor.value,
                            correctLevel: QRCode.CorrectLevel.H
                        });

                        lastColor = frontColor.value;
                        aux.children[0].style.maxWidth = "100%";

                        setTimeout(() => {
                            loader.style.backgroundColor = backColor.value;
                            code.innerHTML = aux.innerHTML;
                            placeholder.style.display = "none";
                            downloadButton.style.display = "";
                            frame.style.borderColor = lastColor;
                            frame.style.backgroundColor = backColor.value;
                            loader.style.display = "none";
                            downloadButton.disabled = false;
                            logoButton.disabled = false;
                        }, 2000);
                    }
                } 
            </script>

            <script>
                var logoShown = false;

                function doShowLogo(){
                    var qrLogo = document.getElementById("qr-logo");
                    var showLogo = document.getElementById("show-logo");
                    logoShown = !logoShown;
                    
                    if(logoShown){
                        qrLogo.style.display = "flex";
                        showLogo.innerHTML = '<i class="bi bi-eye-slash-fill">';
                    }else{
                        qrLogo.style.display = "none";
                        showLogo.innerHTML = '<i class="bi bi-eye-fill">';
                    }
                }
            </script>
    </body>
    <script src="./app.js"></script>
</html>
